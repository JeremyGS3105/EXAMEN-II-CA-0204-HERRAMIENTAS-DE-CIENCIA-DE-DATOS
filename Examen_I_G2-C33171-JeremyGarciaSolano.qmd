---
title: "II PARCIAL"
author: "JEREMY GARCIA SOLANO C33171"
date: "30-12-2025"
subtitle: "HERRAMIENTAS DE CIENCIA DE DATOS"
institute: "UNIVERSIDAD DE COSTA RICA"
titlepage: TRUE
format:
  html: 
    embed-resources: TRUE
---

## Carga de paquetes

```{r}
library(readr)
library(tidyverse)
library(DescTools)
library(rpart)
library(rpart.plot)
```

## Importar base de datos

```{r}
moras <- read.csv("C:/Users/jereg/Downloads/moras.txt")

moras$SALARIO <- gsub(",", ".", moras$SALARIO) #Cambia las comas por puntos
moras$SALARIO <- as.numeric(moras$SALARIO)
```

## 2.Resumen de 5 números

```{r}
moras %>% 
  select(SALARIO,EDAD) %>% 
  summary()
```

## 3. Nueva columna con Z-SCORE

```{r,eval=FALSE}
llenar_NA <- function(df){
  df[df == ""] <- NA
  return(df)
}
moras<-llenar_NA(moras)
  

moras <- moras %>% 
  mutate(
    Z_EDAD =  abs((EDAD - mean(EDAD,na.rm=TRUE)) / sd(EDAD,na.rm=TRUE)),
    CLASIFICACIÓN_EDAD = ifelse(Z_EDAD>1.96,"ATÍPICO","NORMAL"),
    Z_SALARIO =  abs((SALARIO - mean(SALARIO,na.rm=TRUE)) / sd(SALARIO,na.rm=TRUE)),
    CLASIFICACIÓN_SALARIO = ifelse(Z_SALARIO>1.96,"ATÍPICO","NORMAL")
  )
```

```{r}
head(moras)
```

## 4.Calcular el % de NA por columna

```{r}
colSums(is.na(moras)) / nrow(moras) * 100
```


## 5.Imputar NA´s

```{r}
moras$SALARIO[is.na(moras$SALARIO)] <- median(moras$SALARIO, na.rm = TRUE) #Se imputa la mediana ya que es menos influenciada por los outliers

moras$EDAD[is.na(moras$EDAD)] <- median(moras$EDAD, na.rm = TRUE) #Se imputa la mediana ya que es menos influenciada por los outliers

moras$TIPO_ASEGURAMIENTO[is.na(moras$TIPO_ASEGURAMIENTO)] <- Mode(moras$TIPO_ASEGURAMIENTO,na.rm=TRUE) #Se imputa la moda

```

## 6. Gráficos por variable

```{r}
variables_categoricas <- c("SEXO","TIPO_ASEGURAMIENTO",
"SECTOR","INDICADOR_ACTIVO","INDICADOR.EXTRANJERO","INDICADOR_MOROSO")

graficar_categorias <- function(df, variable) {
  ggplot(df, aes(x = .data[[variable]])) +
    geom_bar(fill = "skyblue") +
    labs(
      title = paste("Cantidad de individuos por", variable),
      x = variable,
      y = "Conteo"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

for (j in variables_categoricas) {
  print(graficar_categorias(moras, j))
}
```

**Gráfico de SEXO:** Vemos que en la base de datos hay más hombres que mujeres\
**Gráfico de TIPO_DE_ASEGURAMIENTO:** La mayor concentración de personas está en los asalariados y la menor cantidad está dentro de los convenios especiales.\
**Gráfico por SECTOR:** Se puede notar una gran diferencia entre ambos sectores, hay mas concentracion en el sector privado que en el público\
**Gráfico de INDICADOR_ACTIVO:** La mayor parte de las personas, aún cuentan con un seguro activo.\
**Gráfico por INDICADOR.EXTRANJERO:** Se puede difrenciar la cantidad de personas nacionales y extranjeras dentro de la base de datos.\
**Gráfico por INDICADOR_MOROSO** **:** Hay más personas NO morosas que morosas,\

## 7. Gráficos con porcentajes de NA´s

```{r}
graficar_morosos <- function(data, variable){

  data %>% 
    group_by(.data[[variable]]) %>% 
    summarise(
      total = n(),
      morosos = sum(INDICADOR_MOROSO == "SI"),
      porcentaje = morosos / total * 100
    ) %>%
    ggplot(aes(x = .data[[variable]], y = porcentaje)) +
    geom_col(fill="skyblue") +
    labs(
      title = paste("Porcentaje de morosos por", variable),
      x = variable,
      y = "Porcentaje (%)"
    ) +
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

for(j in variables_categoricas){
  print(graficar_morosos(moras,j))
}
```

**Gráficos de morosos por sexo:** Dentro de la base de datos hay más hombres morosos que mujeres morosas.\
**Gráficos de morosos por tipo de aseguramiento:** El tipo de seguro donde hay mayor porcentaje de morosos, es en los de trabajores independientes, puede deberse a la estabilidad laboral de las personas que adquieren este tipo de seguro, ya que tienen en teoría tienen un trabajo propio.**\
Gráficos de morosos por sector:** Mantienen porcetajes similares, pero como la mayor cantidad está en el sector privado, quiere decir que hay mas morosos en el sector privado que en el público.\
**Gráficos de morosos por activo:** Las personas que no tienen el seguro activo, puede ser por dos cosas, porque ya no lo quieren o porque no lo pagaron, y eso se evidencia en el gráfico mostrando un alto porcentaje de morosos con el seguro no activo.\
**Gráficos de morosos por extranjeros:** Una gran parte de las personas extranjeras son morosas.\

## 8.Gráficos por morosos

```{r}
ggplot(moras, aes(x = SALARIO, fill = INDICADOR_MOROSO)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Distribución del salario por morosidad",
       x = "Salario",
       y = "Frecuencia",
       fill = "Moroso") +
  scale_x_continuous(labels = scales::label_number())+
  theme_minimal()

ggplot(moras, aes(x = EDAD, fill = INDICADOR_MOROSO)) +
  geom_histogram(bins = 20, position = "identity", alpha = 0.6) +
  labs(title = "Distribución de la edad por morosidad",
       x = "Edad",
       y = "Frecuencia",
       fill = "Moroso") +
  scale_x_continuous(labels = scales::label_number())+
  theme_minimal()
```

**Gráfico de SALARIO:** El salario está súper cargado hacia abajo: la mayoría gana poco y solo unos pocos tienen salarios muy altos. Las distribuciones de morosos y no morosos se ven casi iguales, así que el salario no marca mucha diferencia entre ellos. Incluso los salarios altísimos aparecen en ambos grupos, así que tampoco parecen indicar morosidad.

\
**Gráfico de EDAD:** El gráfico muestra que la distribución de edades es muy similar entre morosos y no morosos, con la mayoría concentrada entre los 25 y 55 años. No se observan diferencias claras en la forma o los picos entre ambos grupos, por lo que la edad no parece ser un factor que permita distinguir o predecir la morosidad.

## 10.Árbol

```{r}
moras_1 <- moras %>%
  mutate(
    TIPO_ASEGURAMIENTO = case_when(
      grepl("ASALARIADO", TIPO_ASEGURAMIENTO) ~ "ASALARIADO",
      grepl("VOLUNTARIO", TIPO_ASEGURAMIENTO) ~ "VOLUNTARIO",
      grepl("PENSIONADOS", TIPO_ASEGURAMIENTO) ~ "PENSIONADO",
      grepl("TRABAJADOR INDEPENDIENTE", TIPO_ASEGURAMIENTO) ~ "INDEPENDIENTE",
      grepl("CONVENIOS ESPECIALES", TIPO_ASEGURAMIENTO) ~ "CONVENIO",
      TRUE ~ TIPO_ASEGURAMIENTO
    )
  )
moras_1$IDENTIFICACION <- NULL
tree <- rpart(INDICADOR_MOROSO~., data = moras_1)
rpart.plot(tree)
```

## **Explicación del árbol**

Cada nodo tiene 3 elementos: SI / NO, ún numero entre 0 y 1, y por último un porcetaje. El SI / NO, es el INDICADOR_MOROSOS, el siguiente numero, nos da la probabilidad de estar en la clsificacion de morosidad dada en el nodo, y por último, el número porcentual representa el tamaño de población que cae en dicha clase. Cada nivel tiene su "filtro", por ejemplo, el filtro "salario \< 304e+3" , si la respuesta es si, se recorre el arbol por la derecha, pero si es no, se recorre la izquierda.\
Analicemos el arbol poco a poco.

**Filtro 1:** TIPO_SEGURO=ASALARIADO,CONVENIO,PENSIONADO,VOLUNTARIO: Si se pertenece a ese grupo, el gráfico nos dice que la probabilidad de ser no moroso es de 0.11, y que el 86% de la poblacion tiene ese seguro. Si la respuesta al filtro es NO, entonces la probabilidad de ser moroso es de 0.56, y que el 14% de la poblacion no tienen los seguros mencionados en el filtro.

**Filtro 2:**I NDICADOR_EXTRANJERO=NO: Acá se mantiene la decisión del nodo anterior, seguimos en los que no tienen esos tipos de aseguramiento. Si la persona es no extranjera, es decir, nacional, el grafico muestra que la probabilidad de ser moroso es de 0.52, y que el 12% de la población que no tienen esos seguro, son nacionales. Si es extranjero, la probabilidad de ser moroso es de 0.81 y el 2% porciento de los que no tienen este tipo de seguro son extranjeros.

**Filtro 3:** SALARIO \< 304e+3 : Recuerde que aún se siguen arrastrando los nodos anteriores, entonces estamos dentro de los que no tienen esos seguros, y son nacionales. Si el salario es menor que la cantidad dada, la probabilidad de ser no moroso es de 0.40, y que el 4% de ese 12% tienen ese salario. Y si la cantidad no es menor que esa cantidad, entonces la probabilidad de ser moroso es de 0.58, y el 8% de ese 12% tienen ese salario.